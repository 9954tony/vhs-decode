/* LD decoder prototype, Copyright (C) 2013 Chad Page.  License: LGPL2 */

#include <stdio.h>
#include <iostream>
#include <iomanip>
#include <vector>
#include <list>
#include <queue>
#include <complex>
#include <unistd.h>
#include <sys/fcntl.h>
#include <fftw3.h>
#include <math.h>
#include <stdlib.h>
#include <string.h>

// capture frequency and fundamental NTSC color frequency
const double CHZ = (1000000.0*(315.0/88.0)*8.0);

using namespace std;

double ctor(double r, double i)
{
	return sqrt((r * r) + (i * i));
}

inline double dftc(double *buf, int offset, int len, double bin, double &fc, double &fci) 
{
	fc = 0.0; fci = 0.0;

	for (int k = (-len + 1); k < len; k++) {
//		cout << offset + k << ' ' << len << endl;
		double o = buf[offset + k]; 
		
		fc += (o * cos((2.0 * M_PIl * ((double)(offset - k) / bin)))); 
		fci -= (o * sin((2.0 * M_PIl * ((double)(offset - k) / bin)))); 
	}

	return ctor(fc, fci);
}

inline double dft(double *buf, int offset, int len, double bin) 
{
	double fc, fci;

	return dftc(buf, offset, len, bin, fc, fci);
}

class Filter {
	protected:
		int order;
		bool isIIR;
		vector<double> a, b;
		vector<double> y, x;
	public:
		Filter(int _order, const double *_a, const double *_b) {
			order = _order + 1;
			if (_a) {
				a.insert(b.begin(), _a, _a + order);
				isIIR = true;
			} else {
				a.push_back(1.0);
				isIIR = false;
			}
			b.insert(b.begin(), _b, _b + order);
			x.resize(order);
			y.resize(order);
	
			clear();
		}

		Filter(Filter *orig) {
			order = orig->order;
			isIIR = orig->isIIR;
			a = orig->a;
			b = orig->b;
			x.resize(order);
			y.resize(order);
				
			clear();
		}

		void clear(double val = 0) {
			for (int i = 0; i < order; i++) {
				x[i] = y[i] = val;
			}
		}

		inline double feed(double val) {
			double a0 = a[0];
			double y0;

			double *x_data = x.data();
			double *y_data = y.data();

			memmove(&x_data[1], x_data, sizeof(double) * (order - 1)); 
			if (isIIR) memmove(&y_data[1], y_data, sizeof(double) * (order - 1)); 

			x[0] = val;
			y0 = 0; // ((b[0] / a0) * x[0]);
			//cerr << "0 " << x[0] << ' ' << b[0] << ' ' << (b[0] * x[0]) << ' ' << y[0] << endl;
			if (isIIR) {
				for (int o = 0; o < order; o++) {
					y0 += ((b[o] / a0) * x[o]);
					if (o) y0 -= ((a[o] / a0) * y[o]);
					//cerr << o << ' ' << x[o] << ' ' << y[o] << ' ' << a[o] << ' ' << b[o] << ' ' << (b[o] * x[o]) << ' ' << -(a[o] * y[o]) << ' ' << y[0] << endl;
				}
			} else {
				for (int o = 0; o < order; o++) {
					y0 += b[o] * x[o];
				}
			}

			y[0] = y0;
			return y[0];
		}
		double val() {return y[0];}
};


double f_bpfaud_32_b[] {-4.274276021174761e-03, -2.488356498115624e-03, 1.719837367951319e-03, 9.967306416511662e-03, 2.151523149181729e-02, 3.135594054041439e-02, 3.106676431413005e-02, 1.305182346703847e-02, -2.365612914173255e-02, -6.961110873399148e-02, -1.064086042746723e-01, -1.139718144697020e-01, -8.070816804859979e-02, -1.125476596869346e-02, 7.291826882034491e-02, 1.413481438338137e-01, 1.676264676180753e-01, 1.413481438338137e-01, 7.291826882034491e-02, -1.125476596869345e-02, -8.070816804859980e-02, -1.139718144697020e-01, -1.064086042746724e-01, -6.961110873399151e-02, -2.365612914173255e-02, 1.305182346703847e-02, 3.106676431413005e-02, 3.135594054041441e-02, 2.151523149181730e-02, 9.967306416511661e-03, 1.719837367951320e-03, -2.488356498115625e-03, -4.274276021174761e-03};

Filter f_bandpass(32, NULL, f_bpfaud_32_b);

// [b, a] = butter(6, .32)
double f_lpf_quarter_a[] {1.000000000000000e+00, -2.140755924193053e+00, 2.500582566075432e+00, -1.685599607428541e+00, 6.975629209793702e-01, -1.617798751801715e-01, 1.643942872818916e-02};
double f_lpf_quarter_b[] {3.538273577831657e-03, 2.122964146698994e-02, 5.307410366747485e-02, 7.076547155663314e-02, 5.307410366747485e-02, 2.122964146698994e-02, 3.538273577831657e-03};

// b=fir2(64, [0.0, 1.85/freq, 2.1/freq, 3.0/freq, 3.25/freq, 1], [0, 0, 1, 1, 0, 0])

double f_lpf_quarter64_2ch_b[] {-6.378418695449696e-04, -6.865695191419821e-05, 4.771641580941544e-04, 8.451488830495845e-04, 9.010530003969349e-04, 6.236273046937000e-04, 1.964267562559569e-04, -6.134522846292778e-06, 3.928052991381848e-04, 1.457568379454407e-03, 2.678442041466711e-03, 2.994170549401783e-03, 1.229663303236383e-03, -3.151966642431959e-03, -9.336359757760298e-03, -1.495121648384806e-02, -1.669405389830028e-02, -1.174112860392878e-02, 5.797730154887880e-04, 1.767058487149051e-02, 3.384510053359726e-02, 4.207095802523704e-02, 3.679883106055227e-02, 1.676592624947535e-02, -1.354391544736211e-02, -4.469653698017552e-02, -6.536823024181375e-02, -6.664578519521241e-02, -4.585747822572043e-02, -8.251916687134743e-03, 3.437176990156273e-02, 6.773296893777304e-02, 8.031907515092329e-02, 6.773296893777304e-02, 3.437176990156273e-02, -8.251916687134745e-03, -4.585747822572043e-02, -6.664578519521243e-02, -6.536823024181375e-02, -4.469653698017552e-02, -1.354391544736211e-02, 1.676592624947535e-02, 3.679883106055226e-02, 4.207095802523705e-02, 3.384510053359728e-02, 1.767058487149051e-02, 5.797730154887895e-04, -1.174112860392879e-02, -1.669405389830029e-02, -1.495121648384807e-02, -9.336359757760298e-03, -3.151966642431960e-03, 1.229663303236383e-03, 2.994170549401782e-03, 2.678442041466714e-03, 1.457568379454407e-03, 3.928052991381851e-04, -6.134522846293424e-06, 1.964267562559574e-04, 6.236273046937000e-04, 9.010530003969354e-04, 8.451488830495845e-04, 4.771641580941547e-04, -6.865695191419721e-05, -6.378418695449696e-04}; 

double f_lpf_quarter256_left_b[] {3.028933078147309e-05, -3.268590357435501e-05, -8.012294924281947e-05, -1.022037644506397e-04, -9.665092531427608e-05, -6.863430979822163e-05, -2.871281865964732e-05, 1.057361489520123e-05, 3.849522060912144e-05, 4.922674445046305e-05, 4.333562903614693e-05, 2.718955352500047e-05, 1.041366195219119e-05, 2.146420564856693e-06, 7.291572959799406e-06, 2.408131195158831e-05, 4.396962351456847e-05, 5.420059152955513e-05, 4.250874948652268e-05, 2.569403412985491e-06, -6.168374692362375e-05, -1.346923619273312e-04, -1.919736107170322e-04, -2.067858250807378e-04, -1.592526758805491e-04, -4.528470891719494e-05, 1.178306541648127e-04, 2.918002752854140e-04, 4.248136994543049e-04, 4.651711165419190e-04, 3.778642978027876e-04, 1.593484732591719e-04, -1.545777131234705e-04, -4.916148507729283e-04, -7.576681764421595e-04, -8.610420974256878e-04, -7.403861525661746e-04, -3.885177323993047e-04, 1.358052969186697e-04, 7.137181150390521e-04, 1.190812009709151e-03, 1.416103014494046e-03, 1.286125919657034e-03, 7.819743102063827e-04, -1.257738891640544e-05, -9.198592805808413e-04, -1.705230175640085e-03, -2.135352545761016e-03, -2.043949609253492e-03, -1.387228166489713e-03, -2.718731751737145e-04, 1.055736639164960e-03, 2.260752363914471e-03, 3.001883256845720e-03, 3.024764496646533e-03, 2.241810595861378e-03, 7.747732002597818e-04, -1.055868567275917e-03, -2.797350126645493e-03, -3.974259062022318e-03, -4.215446388535287e-03, -3.364954551554898e-03, -1.544942204713581e-03, 8.511580692498943e-04, 3.239784687203369e-03, 4.987211156097031e-03, 5.575357297229568e-03, 4.750580993192165e-03, 2.613650115500022e-03, -3.782842788741989e-04, -3.505276677295232e-03, -5.955936459960961e-03, -7.036298832560825e-03, -6.362829003024035e-03, -3.986577245332196e-03, -4.103119317987369e-04, 3.513367845812174e-03, 6.783748923593283e-03, 8.506290752011200e-03, 8.135084689984992e-03, 5.638205002064201e-03, 1.537277913156405e-03, -3.196740355868726e-03, -7.372303925907820e-03, -9.877017157238958e-03, -9.973013480875597e-03, -7.509706296062709e-03, -2.993451508863558e-03, 2.511520785935341e-03, 7.633173399923376e-03, 1.103422627852792e-02, 1.176154456435314e-02, 9.510964976061277e-03, 4.734401240120033e-03, -1.445568880704716e-03, -7.499267614399590e-03, -1.186989002627388e-02, -1.337517662323770e-02, -1.152679384900049e-02, -6.681166583136579e-03, 2.344917148789090e-05, 6.934529497155366e-03, 1.229460401830413e-02, 1.469045901180300e-02, 1.342682214068310e-02, 8.725402016722752e-03, 1.692814478435086e-03, -5.940488199229212e-03, -1.224859355365926e-02, -1.559913352506378e-02, -1.507797568427917e-02, -1.073851519764662e-02, -3.607549432621548e-03, 4.558633999582235e-03, 1.170981085293223e-02, 1.602025990328295e-02, 1.635806146861521e-02, 1.258381263717549e-02, 5.599534826248619e-03, -2.868116578894587e-03, -1.069795288652692e-02, -1.590972380624895e-02, -1.716875839741163e-02, -1.413021345862274e-02, -7.533514311036624e-03, 9.788964802308815e-04, 9.273751501475060e-03, 1.526583385638250e-02, 1.744634454900568e-02, 1.526583385638250e-02, 9.273751501475058e-03, 9.788964802308815e-04, -7.533514311036623e-03, -1.413021345862274e-02, -1.716875839741163e-02, -1.590972380624895e-02, -1.069795288652692e-02, -2.868116578894587e-03, 5.599534826248619e-03, 1.258381263717549e-02, 1.635806146861521e-02, 1.602025990328295e-02, 1.170981085293223e-02, 4.558633999582235e-03, -3.607549432621549e-03, -1.073851519764662e-02, -1.507797568427917e-02, -1.559913352506378e-02, -1.224859355365926e-02, -5.940488199229214e-03, 1.692814478435086e-03, 8.725402016722754e-03, 1.342682214068310e-02, 1.469045901180299e-02, 1.229460401830413e-02, 6.934529497155365e-03, 2.344917148789168e-05, -6.681166583136579e-03, -1.152679384900050e-02, -1.337517662323770e-02, -1.186989002627388e-02, -7.499267614399590e-03, -1.445568880704716e-03, 4.734401240120036e-03, 9.510964976061279e-03, 1.176154456435315e-02, 1.103422627852791e-02, 7.633173399923376e-03, 2.511520785935340e-03, -2.993451508863559e-03, -7.509706296062710e-03, -9.973013480875599e-03, -9.877017157238958e-03, -7.372303925907820e-03, -3.196740355868729e-03, 1.537277913156406e-03, 5.638205002064203e-03, 8.135084689984990e-03, 8.506290752011200e-03, 6.783748923593282e-03, 3.513367845812175e-03, -4.103119317987364e-04, -3.986577245332197e-03, -6.362829003024037e-03, -7.036298832560826e-03, -5.955936459960962e-03, -3.505276677295233e-03, -3.782842788741988e-04, 2.613650115500022e-03, 4.750580993192165e-03, 5.575357297229568e-03, 4.987211156097032e-03, 3.239784687203370e-03, 8.511580692498947e-04, -1.544942204713582e-03, -3.364954551554899e-03, -4.215446388535290e-03, -3.974259062022320e-03, -2.797350126645493e-03, -1.055868567275917e-03, 7.747732002597818e-04, 2.241810595861378e-03, 3.024764496646534e-03, 3.001883256845720e-03, 2.260752363914473e-03, 1.055736639164960e-03, -2.718731751737150e-04, -1.387228166489714e-03, -2.043949609253492e-03, -2.135352545761015e-03, -1.705230175640085e-03, -9.198592805808413e-04, -1.257738891640542e-05, 7.819743102063823e-04, 1.286125919657034e-03, 1.416103014494047e-03, 1.190812009709152e-03, 7.137181150390523e-04, 1.358052969186700e-04, -3.885177323993043e-04, -7.403861525661745e-04, -8.610420974256879e-04, -7.576681764421595e-04, -4.916148507729283e-04, -1.545777131234706e-04, 1.593484732591720e-04, 3.778642978027880e-04, 4.651711165419194e-04, 4.248136994543053e-04, 2.918002752854144e-04, 1.178306541648127e-04, -4.528470891719502e-05, -1.592526758805493e-04, -2.067858250807380e-04, -1.919736107170324e-04, -1.346923619273312e-04, -6.168374692362377e-05, 2.569403412985586e-06, 4.250874948652272e-05, 5.420059152955517e-05, 4.396962351456851e-05, 2.408131195158828e-05, 7.291572959799490e-06, 2.146420564856709e-06, 1.041366195219122e-05, 2.718955352500050e-05, 4.333562903614694e-05, 4.922674445046306e-05, 3.849522060912149e-05, 1.057361489520124e-05, -2.871281865964729e-05, -6.863430979822164e-05, -9.665092531427604e-05, -1.022037644506397e-04, -8.012294924281943e-05, -3.268590357435504e-05, 3.028933078147309e-05};


//Filter f_quarter(6, f_lpf_quarter_a, f_lpf_quarter_b);
Filter f_quarter(256, NULL, f_lpf_quarter256_left_b);

// [b, a] = butter(3, .05/(freq/4));
double f_lpf01_2fsc_a[] {1.000000000000000e+00, -2.912241901643419e+00, 2.828292351114106e+00, -9.159695351108759e-01};
double f_lpf01_2fsc_b[] {1.011429497640438e-05, 3.034288492921315e-05, 3.034288492921315e-05, 1.011429497640438e-05};

Filter f_lpf01(3, f_lpf01_2fsc_a, f_lpf01_2fsc_b);

// [b, a] = butter(8, .05/(freq/4)); freqz(b, a)
double f_bw_butter8_a[] {1.000000000000000e+00, -7.775067326231071e+00, 2.645069259842671e+01, -5.142591273705536e+01, 6.249662457557615e+01, -4.861386304351296e+01, 2.363699401111408e+01, -6.568017814173656e+00, 7.985497358684126e-01};
double f_bw_butter8_b[] {4.806230409482173e-14, 3.844984327585739e-13, 1.345744514655009e-12, 2.691489029310017e-12, 3.364361286637521e-12, 2.691489029310017e-12, 1.345744514655009e-12, 3.844984327585739e-13, 4.806230409482173e-14};

Filter f_bw_butter8(8, f_bw_butter8_a, f_bw_butter8_b);

typedef vector<complex<double>> v_cossin;

class FM_demod {
	protected:
		vector<Filter> f_q, f_i;
		Filter *f_pre, *f_post;

		vector<v_cossin> ldft;
		vector<double> avglevel;
	
		int linelen;

		int min_offset;

		vector<double> fb;
	public:
		FM_demod(int _linelen, vector<double> _fb, Filter *prefilt, vector<Filter *> filt, Filter *postfilt, double freq = CHZ) {
			int i = 0;
			linelen = _linelen;

			fb = _fb;

			for (double f : fb) {
				v_cossin tmpdft;
				double fmult = f / freq; 

				for (int i = 0; i < linelen; i++) {
					tmpdft.push_back(complex<double>(sin(i * 2.0 * M_PIl * fmult), cos(i * 2.0 * M_PIl * fmult))); 
				}	
				ldft.push_back(tmpdft);

				f_i.push_back(Filter(filt[i]));
				f_q.push_back(Filter(filt[i]));

				i++;
			}
	
			f_pre = prefilt ? new Filter(*prefilt) : NULL;
			f_post = postfilt ? new Filter(*postfilt) : NULL;

			avglevel.assign(_fb.size(), 30.0);

			min_offset = 256 + 16;
		}

		~FM_demod() {
			if (f_pre) free(f_pre);
			if (f_post) free(f_post);
		}

		vector<double> process(vector<double> in) 
		{
			vector<double> out;
			vector<double> phase(fb.size() + 1);
			vector<double> level(fb.size() + 1);
			double avg = 0, total = 0.0;

			if (in.size() < (size_t)linelen) return out;

			for (double n : in) avg += n / in.size();

			int i = 0;
			for (double n : in) {
				vector<double> angle(fb.size() + 1);
				double peak = 500000, pf = 0.0;
				int npeak;
				int j = 0;

				n -= avg;
				total += fabs(n);
				if (f_pre) n = f_pre->feed(n);

				angle[j] = 0;

				//cerr << n << endl;
	
				for (double f: fb) {
					double fci = f_i[j].feed(n * ldft[j][i].real());
					double fcq = f_q[j].feed(-n * ldft[j][i].imag());
					double at2 = atan2(fci, fcq);	
	
//					cerr << fci << ' ' << fcq << endl;

					level[j] = ctor(fci, fcq);
	
					angle[j] = at2 - phase[j];
					if (angle[j] > M_PIl) angle[j] -= (2 * M_PIl);
					else if (angle[j] < -M_PIl) angle[j] += (2 * M_PIl);
						
					if (fabs(angle[j]) < fabs(peak)) {
						npeak = j;
						peak = angle[j];
						pf = f + ((f / 2.0) * angle[j]);
					}
					phase[j] = at2;

				//	cerr << f << ' ' << pf << ' ' << f + ((f / 2.0) * angle[j]) << ' ' << fci << ' ' << fcq << ' ' << ' ' << level[j] << ' ' << phase[j] << ' ' << peak << endl;

					j++;
				}
					
				if (i > min_offset) out.push_back(pf);
				i++;
			}

//			cerr << total / in.size() << endl;
			return out;
		}
};

int main(int argc, char *argv[])
{
	int rv = 0, fd = 0, dlen = -1 ;
	//double output[2048];
	unsigned char inbuf[2048];

	cerr << std::setprecision(10);
	cerr << argc << endl;
	cerr << strncmp(argv[1], "-", 1) << endl;

	if (argc >= 2 && (strncmp(argv[1], "-", 1))) {
		fd = open(argv[1], O_RDONLY);
	}

	if (argc >= 3) {
		unsigned long long offset = atoll(argv[2]);

		if (offset) lseek64(fd, offset, SEEK_SET);
	}
		
	if (argc >= 3) {
		if ((size_t)atoi(argv[3]) < dlen) {
			dlen = atoi(argv[3]); 
		}
	}

	cout << std::setprecision(8);
	
	rv = read(fd, inbuf, 2048);

	int i = 2048;
	
//	vector<double> fb({7600000, 8100000, 8300000, 8500000, 8700000, 8900000, 9100000, 9300000}); 
//	vector<double> fb({7600000, 8100000, 8600000, 9100000}); 
	vector<double> fb({2300000}); 
	//vector<double> fb({8500000}); 

	FM_demod video(2048, {2300000}, NULL, {&f_lpf01}, NULL, CHZ);
//	FM_demod video(2048, fb, NULL, &f_lpf45, NULL);

	double t_n = 0.0;

	int x = 0, total = 0;	
	double pt = 1, t = 0;
	int zc_count = 0;
	double zc_dist = 0;
//	int crosspoint = 0;
	while ((rv == 2048) && ((dlen == -1) || (i < dlen))) {
		vector<double> dinbuf;
		vector<unsigned short> ioutbuf;

		for (int j = 0; j < 2048; j++) {
			dinbuf.push_back(f_quarter.feed(inbuf[j]));
		}

		vector<double> outline = video.process(dinbuf);

		vector<short> bout;
				
		t_n = 0;

		//cerr << 'L' << outline.size() << endl;
		for (int i = 0; i < outline.size(); i++) {
			double n = outline[i];
			short output;

			total++;

			if (!(total % 573)) {
//				cerr << 'T' << n << endl;
				n -= 2300000.0;
				n /= (150000.0);
				if (n < -1) n = -1;
				if (n > 1) n = 1;
				output = n * 32767;
				bout.push_back(output);
			}
		}
		
		short *boutput = bout.data();
		int len = outline.size();
		if (write(1, boutput, bout.size() * 2) != bout.size() * 2) {
			//cerr << "write error\n";
			exit(0);
		}
	
		i += (len >= 2048) ? 2048 : len;
		memmove(inbuf, &inbuf[len], 2048 - len);
		rv = read(fd, &inbuf[(2048 - len)], len) + (2048 - len);
		
		if (rv < 2048) return 0;
		//cerr << i << ' ' << rv << endl;
	}
	return 0;
}

